/*****************************
 * Maheshwar edited file 14 Jan 2013
 *Author:JAYANT PATIL
 *COMPANY NAME XNet Inc,Pune.
 *last modified date:01-jan-2013
 *
 *
 *
 *Description:
 *this function will create folder hierarchies if not found and
 *
 *variables :
 *count --->contains array of date in which we take one date process files regarding to that
 *n     --->it is a counter variable
 *baseurl-->it contians all url for nse equity
 *downloadpath---> it contain download path of file for processing
 *unzippath  ----> it contains unzip folder path
 *outputpah  ----> it containds output older path
 *root       ----> it contains path of output folder to process file like C:/data
 *
 *Functions:
 *downloadseclist-----> this fun download seclist.csv
 *downloadfiles  -----> this fun download nse equity, mto, file for each date available
 *loadevent and download -----> these are the functions for start up
 *performtask    -----> this is used for calling downloadfiles fun and set count i.e no of date are present or to download files for that dates
 *getMonth       -----> this is used for the convertting from string month to integer month i.e. in number
 *                      it get mon vaiable and conert it to interger reutrn number format
 *getmnth        -----> this is used for the convertting integer month to string month
 *                      in this parameter mon
 *
 *
 *copyright 2013,
 ******************************/
var http = require('http'),fs = require('fs'),
                          request = require('request'),
                          AdmZip = require('adm-zip');

function loadevent(){
var baseurl=new Array();
var csv = require('ya-csv');
//var setting=new Array();
var reader = csv.createCsvFileReader('html/baseurl.csv',{'separator': ','});
reader.addListener('data', function(data) {
    baseurl.push(data);
    if(data[0]=="end"){
       //download(baseurl);
    }
});
reader = csv.createCsvFileReader('html/setting.csv',{'separator': ','});
reader.addListener('data', function(data) {
    
    if(data[0]=="datafolder"){
       baseurl.push(data);
       download(baseurl);
    }
});

}
function downloadseclist(downloadpath)
{
    var http = require('http'),fs = require('fs'), request = require('request');

//// Downloading NSE Security list////
   var url_seclist='http://www.nseindia.com/content/equities/sec_list.csv';
        request(
        {
            method: 'GET',
            uri: url_seclist,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        },
            function(error, response, body) {
            if (!error && response.statusCode == 200) {
            downloadcsv(response.statusCode);
            }
            else
               {
            downloadcsv(404);
              }
        }
        );
 function downloadcsv(statuscode)
 {
if(statuscode==200){
var secout = fs.createWriteStream(downloadpath+'sec_list.csv'); // For saving NSE Equity Sec list
var req=request(
        {
            method: 'GET',
            uri: url_seclist,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        });
req.pipe(secout);        
req.on('end',function(){
document.getElementById("om").innerHTML+="<br/>sec_list is downloaded";            
});

 }
 else
  document.getElementById("om").innerHTML+="<br/><font color=red>sec_list.csv  is not on server</font>";
  
}

}
function download(baseurl)
        {

        document.getElementById("om").innerHTML="loading..."
        for(var i=0; i<baseurl.length;i++)
            {
                if(baseurl[i].toString().split(',')[0]=="datafolder")
                 {   //document.getElementById("om").innerHTML+="data-"+baseurl[i].toString().split(',')[1];
                    makedir(baseurl[i].toString().split(',')[1]);
                    var root =baseurl[i].toString().split(',')[1];
                    var downloadpath=root+'/download/';  //path of file downloading folder
                    var unzippath=root+'/download/unzip/';//path of file unzippin folder
                   // var temppath=root+'/temp/';//path of file unzippin folder
                    var logpath=root+'/logs/';//path of file unzippin folder
                    var outputpath=root+'/equity/nse/';
					var bse_outputpath=root+'/bse/';
                    
            }}
                    
                    setTimeout(performtask,2000,baseurl,downloadpath,unzippath,outputpath,logpath,bse_outputpath); //call to function for perform task of downloading and processing..
        
  
        }
function downloadfiles(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)//(baseurl,mon,m,d,yy)
{
try{
var mon=count[n].split('-')[0];
var m=count[n].split('-')[1];
var d=count[n].split('-')[2];
var yy=count[n].split('-')[3];
var y=yy.substr(2,2);
var month=mon.toUpperCase()

var file_url='',file_url1='';
for (var i=0;i<baseurl.length;i++)
    {
        if(baseurl[i].toString().split(',')[0]=='nsecmbhavcopy')
            file_url=baseurl[i].toString().split(',')[1]+yy+'/'+month+'/cm'+d+''+month+''+yy+'bhav.csv.zip';
       //if(baseurl[i].toString().split(',')[0]=='nsemto')
         //   file_url1=baseurl[i].toString().split(',')[1]+'MTO_'+d+''+m+''+yy+'.DAT';
    }


var url = require('url');

    var http = require('http'),
              fs = require('fs'),
              AdmZip = require('adm-zip'),
              request = require('request');
               // For saving NSE Equity  Security-wise Delivery Position
              
// Downloading NSE Bhavcopy


request(
        {
            method: 'GET',
            uri: file_url,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        },
            function(error, response, body) {
            if(response != null)
   {
    if(response.statusCode != null || response.statusCode != "")
    {
     if (!error && response.statusCode == 200)
     {
      downloadcsvzip(response.statusCode);
     }
     else
        {
      downloadcsvzip(404);
     }
    }else
        {
      downloadcsvzip(404);
     }
   }else
   {
    downloadcsvzip(404);

   }
   }
        );
 function downloadcsvzip(statuscode)
 {
if(statuscode==200){
var out = fs.createWriteStream(downloadpath+'cm'+d+month+yy+'bhav.csv.zip'); // For saving NSE Equity bhavcopy
var req = request(
    {
        method: 'GET',
        uri: file_url,
        headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
            "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
            "Accept-Encoding": "gzip,deflate,sdch",
            "encoding": "null",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*//*;q=0.8",
            "Cookie": "cookie"
        }
    }
);
req.on('error',function(){
document.getElementById("om").innerHTML+='<br/>Error occured in downloading cm'+d+month+yy+'bhav.csv.zip';
setTimeout(function (){downloadfiles(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
});
req.pipe(out);   //request pipeout
req.on('end', function() {
    document.getElementById("om").innerHTML+='<br>cm'+d+month+yy+'bhav.csv.zip is downloaded...'
    var zip = new AdmZip(downloadpath+'cm'+d+month+yy+'bhav.csv.zip');
    zip.extractAllTo(unzippath, /*overwrite*/true);
    document.getElementById("om").innerHTML+='<br>cm'+d+month+yy+'bhav.csv.zip is extracted...'



        n++;
        if(count.length>n)
        {
        setTimeout(function (){downloadfiles(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
        downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath);
        }

});

 }
 else
 { document.getElementById("om").innerHTML+='<br/><font color=red>cm'+d+month+yy+'bhav.csv.zip is not present on server</font>';
   n++;
   /*if(count.length==1){
        $("#p3").hide();
    }
   else
    {*/if(count.length>n)
        {
        setTimeout(function (){downloadfiles(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
        downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath);
        }
    
 }
}



/**************end of download bhav csv*************/
    
  

}
catch(err){
document.getElementById("om").innerHTML+="<br/>File is not found for this date: "+d+m+yy;
setTimeout(function (){downloadfiles(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
}
}
function performtask(baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)
{
	   var datefrom=document.getElementById("datefield-1029-inputEl").value;
            var dateto=document.getElementById("datefield-1031-inputEl").value;
            var fromdate=datefrom.split('/');
            var todate=dateto.split('/');
			var count=new Array();
            $(document).ready(function(){
            var bd,beginDate = new Date(fromdate[0]+','+fromdate[1]+','+fromdate[2]);
            var ed,endDate = new Date(todate[0]+','+todate[1]+','+todate[2]);

            var mnth,dy;
            while (beginDate <= endDate) {
            if(!beginDate.toDateString().match('Sat')&& !beginDate.toDateString().match('Sun'))
            {

                if((beginDate.getMonth()+1)<10)
                mnth=0+''+(beginDate.getMonth()+1);
                else
                mnth=beginDate.getMonth()+1;

                if(beginDate.getDate()<10)
                dy=0+''+beginDate.getDate();
                else
                dy=beginDate.getDate();
				var mon,m,d,yy;
				mon=beginDate.toDateString().split(" ")[1];
				m=mnth;
				d=dy;
				yy=beginDate.getFullYear();

		//		document.getElementById("om").innerHTML+='<br/>performing task for'+d+mon+yy;
                                var dm=d+'-'+m;
                                count.push(mon+'-'+m+'-'+d+'-'+yy);
            }

            beginDate.setTime(beginDate.getTime() + 86400000);
            }});
        if(count.length>0)
        {
            downloadseclist(downloadpath); //calling function to downoad seclist file
            downloadfiles(count,0,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)
        }
        else
            $("#p3").hide();
        
}
function getmonth(mon){
             switch(parseInt(mon))
            {
                case 1:
                    mon='JAN';
                    break;
                case 2:
                    mon='FEB';
                    break;
                case 3:
                    mon='MAR';
                    break;
                case 4:
                    mon='APR';
                    break;
                case 5:
                    mon='MAY';
                    break;
                case 6:
                    mon='JUN';
                    break;
                case 7:
                    mon='JUL';
                    break;
                case 8:
                    mon='AUG';
                    break;
                case 9:
                    mon='SEP';
                    break;
                case 10:
                    mon='OCT';
                    break;
                case 11:
                    mon='NOV';
                    break;
                case 12:
                    mon='DEC';
                    break;

            }
            return mon;
        }
function getMonth(mon){
             switch(mon.toUpperCase())
            {
                case 'JAN':
                    mon='01';
                    break;
                case 'FEB':
                    mon='02';
                    break;
                case 'MAR':
                    mon='03';
                    break;
                case 'APR':
                    mon='04';
                    break;
                case 'MAY':
                    mon='05';
                    break;
                case 'JUN':
                    mon='06';
                    break;
                case 'JUL':
                    mon='07';
                    break;
                case 'AUG':
                    mon='08';
                    break;
                case 'SEP':
                    mon='09';
                    break;
                case 'OCT':
                    mon='10';
                    break;
                case 'NOV':
                    mon='11';
                    break;
                case 'DEC':
                    mon='12';
                    break;

            }
            return mon;
        }

   // Downloading NSE Security-wise Delivery Position

function downloadmto(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)
{
var mon=count[n].split('-')[0];
var m=count[n].split('-')[1];
var d=count[n].split('-')[2];
var yy=count[n].split('-')[3];
var y=yy.substr(2,2);
var month=mon.toUpperCase()

var file_url='',file_url1='';
for (var i=0;i<baseurl.length;i++)
    {
       if(baseurl[i].toString().split(',')[0]=='nsemto')
         file_url1=baseurl[i].toString().split(',')[1]+'MTO_'+d+''+m+''+yy+'.DAT';
    }

var   request = require('request');
      request(
        {
            method: 'GET',
            uri: file_url1,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        },
            function(error, response, body) {
            if(response != null)
   {
    if(response.statusCode != null || response.statusCode != "")
    {
     if (!error && response.statusCode == 200)
     {
      download_dat(response.statusCode);
     }
     else
        {
      download_dat(404);
     }
    }else
        {
      download_dat(404);
     }
   }else
   {
    download_dat(404);

   }
   }
        );
function download_dat(statuscode)
 {
var fs=require('fs');
if(statuscode==200){
var datout = fs.createWriteStream(downloadpath+'MTO_'+d+''+m+''+yy+'.DAT');
var req1=   request(
             {method: 'GET',
                 uri: file_url1,          //'http://nseindia.com/archives/equities/mto/MTO_'+d+''+m+''+yy+'.DAT',
                 headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
             }
              );
   req1.on('error',function(){
    document.getElementById("om").innerHTML+='<br/>Error occured in downloading MTO_'+d+''+m+''+yy+'.DAT';

setTimeout(function (){downloadmto(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
    });
   req1.pipe(datout);
   req1.on('end', function() {
        document.getElementById("om").innerHTML+='<br>MTO_'+d+''+m+''+yy+'.DAT is downloaded ..' ;

        n++;
        if(count.length>n)
        {
        setTimeout(function (){downloadmto(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
        //process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);
        download_przip(count,0,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)
        }
     });
}
else
{
   document.getElementById("om").innerHTML+='<br/><font color=red>MTO_'+d+''+m+''+yy+'.DAT is not present on server</font>';
   n++;
        if(count.length>n)
        {
        setTimeout(function (){downloadmto(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
       // process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);
       download_przip(count,0,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)
        }
}
 
        
 }
 }
function download_przip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)//(baseurl,mon,m,d,yy)
{
try{


var mon=count[n].split('-')[0];
var m=count[n].split('-')[1];
var d=count[n].split('-')[2];
var yy=count[n].split('-')[3];
var y=yy.substr(2,2);
var month=mon.toUpperCase();
document.getElementById("om").innerHTML+='<br/>PR'+d+m+y+'.zip is downloading..';
var file_url;//'http://nseindia.com/archives/equities/bhavcopy/pr/PR'+m+d+y+'.zip';//,file_url1='';
for (var i=0;i<baseurl.length;i++)
    {
        if(baseurl[i].toString().split(',')[0]=='nseprbhavcopy')
            file_url=baseurl[i].toString().split(',')[1]+'PR'+d+m+y+'.zip';
       //if(baseurl[i].toString().split(',')[0]=='nsemto')
         //   file_url1=baseurl[i].toString().split(',')[1]+'MTO_'+d+''+m+''+yy+'.DAT';
    }


var url = require('url');
var http = require('http'),fs = require('fs'),AdmZip = require('adm-zip'),request = require('request');

//Download PR Bhavcopy File for NSE
request(
        {
            method: 'GET',
            uri: file_url,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        },
            function(error, response, body) {
            if(response != null)
   {
    if(response.statusCode != null || response.statusCode != "")
    {
     if (!error && response.statusCode == 200)
     {
      downloadcsvzip(response.statusCode);
     }
     else
        {
      downloadcsvzip(404);
     }
    }else
        {
      downloadcsvzip(404);
     }
   }else
   {
    downloadcsvzip(404);

   }

        }
        );
 function downloadcsvzip(statuscode)
 {
if(statuscode==200){

var out = fs.createWriteStream(downloadpath+'PR'+d+m+y+'.zip'); // For saving NSE Equity bhavcopy
var req = request(
    {
        method: 'GET',
        uri: file_url,
        headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
            "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
            "Accept-Encoding": "gzip,deflate,sdch",
            "encoding": "null",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*//*;q=0.8",
            "Cookie": "cookie"
        }
    }
);
req.on('error',function(){
document.getElementById("om").innerHTML+='<br/>Error occured in downloading PR'+d+m+y+'.zip';
download_przip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)//(baseurl,mon,m,d,yy)
});
req.pipe(out);   //request pipeout
req.on('end', function() {
    document.getElementById("om").innerHTML+='<br>PR'+d+m+y+'.zip is downloaded...'
    var zip = new AdmZip(downloadpath+'PR'+d+m+y+'.zip');
    zip.extractAllTo(unzippath, /*overwrite*/true);
    document.getElementById("om").innerHTML+='<br>PR'+d+m+y+'.zip is extracted...'
    zip = new AdmZip(unzippath+'fo'+d+m+yy+'.zip');
    zip.extractAllTo(unzippath+'unzip1/', /*overwrite*/true);
    //document.getElementById("om").innerHTML+='<br>fo'+d+m+yy+'.zip is extracted...';
    zip = new AdmZip(unzippath+'cd'+d+m+yy+'.zip');
    zip.extractAllTo(unzippath+'unzip1/', /*overwrite*/true);
    //document.getElementById("om").innerHTML+='<br>cd'+d+m+yy+'.zip is extracted...'

        n++;
        if(count.length>n)
        {
        setTimeout(function (){download_przip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
        //downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath);
        //download_nse_cmbnd_rpt_zip(count,0,baseurl,downloadpath,unzippath,outputpath);
		//process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);
        process_bse_indexdata(baseurl,downloadpath,unzippath,bse_outputpath);
        }

});

 }
 else
 { document.getElementById("om").innerHTML+='<br/><font color=red>PR'+m+d+y+'.zip is not present on server</font>';
   n++;
   /*if(count.length==1){
        $("#p3").hide();
    }
   else
    {*/if(count.length>n)
        {
        setTimeout(function (){download_przip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath, bse_outputpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>nse processing.."+n;
        //downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath);
        //download_nse_cmbnd_rpt_zip(count,0,baseurl,downloadpath,unzippath,outputpath);
		//process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);
        process_bse_indexdata(baseurl,downloadpath,unzippath,bse_outputpath);
    }
    }
 
}



/**************end of download bhav csv*************/



}
catch(err){
document.getElementById("om").innerHTML+="<br/>File is not found for this date: <br/>"+err;
setTimeout(function (){download_przip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
}
}
function download_nse_cmbnd_rpt_zip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)//(baseurl,mon,m,d,yy)
{
try{


var mon=count[n].split('-')[0];
var m=count[n].split('-')[1];
var d=count[n].split('-')[2];
var yy=count[n].split('-')[3];
var y=yy.substr(2,2);
var month=mon.toUpperCase();
document.getElementById("om").innerHTML+='<br/>combined_report'+d+m+yy+'.zip is downloading..';
var file_url;//'http://nseindia.com/archives/equities/bhavcopy/pr/PR'+m+d+y+'.zip';//,file_url1='';
for (var i=0;i<baseurl.length;i++)
    {
        if(baseurl[i].toString().split(',')[0]=='nsecmbndrpt')
            file_url=baseurl[i].toString().split(',')[1]+'combined_report'+d+m+yy+'.zip';
       //if(baseurl[i].toString().split(',')[0]=='nsemto')
         //   file_url1=baseurl[i].toString().split(',')[1]+'MTO_'+d+''+m+''+yy+'.DAT';
    }


var url = require('url');
var http = require('http'),fs = require('fs'),AdmZip = require('adm-zip'),request = require('request');

//Download PR Bhavcopy File for NSE
request(
        {
            method: 'GET',
            uri: file_url,
            headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
                     "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
                     "Accept-Encoding": "gzip,deflate,sdch",
                     "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8",
                     "Cookie": "cookie"
                 }
        },
            function(error, response, body) {
            if(response != null)
   {
    if(response.statusCode != null || response.statusCode != "")
    {
     if (!error && response.statusCode == 200)
     {
      downloadcsvzip(response.statusCode);
     }
     else
        {
      downloadcsvzip(404);
     }
    }else
        {
      downloadcsvzip(404);
     }
   }else
   {
    downloadcsvzip(404);

   }

        }
        );
 function downloadcsvzip(statuscode)
 {
if(statuscode==200){

var out = fs.createWriteStream(downloadpath+'combined_report'+d+m+yy+'.zip'); // For saving NSE Equity bhavcopy
var req = request(
    {
        method: 'GET',
        uri: file_url,
        headers: {"User-Agent": "Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.11 (KHTML, like Gecko) Chrome/23.0.1271.97 Safari/537.11",
            "Referer": "http://www.nseindia.com/products/content/all_daily_reports.htm",
            "Accept-Encoding": "gzip,deflate,sdch",
            "encoding": "null",
            "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*//*;q=0.8",
            "Cookie": "cookie"
        }
    }
);
req.on('error',function(){
document.getElementById("om").innerHTML+='<br/>Error occured in downloading combined_report'+d+m+yy+'.zip';
setTimeout(function (){download_nse_cmbnd_rpt_zip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
});
req.pipe(out);   //request pipeout
req.on('end', function() {
    document.getElementById("om").innerHTML+='<br>combined_report'+d+m+yy+'.zip is downloaded...'
    var zip = new AdmZip(downloadpath+'combined_report'+d+m+yy+'.zip');
    zip.extractAllTo(unzippath, /*overwrite*/true);
    document.getElementById("om").innerHTML+='<br>combined_report'+d+m+yy+'.zip is extracted...'

    n++;
        if(count.length>n)
        {
        setTimeout(function (){download_nse_cmbnd_rpt_zip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>NSE cmbnd rpt is processing.."+n;
        //downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath);
        //process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);
        //process_nse_cmbnd_rpt(count,0,baseurl,downloadpath,unzippath,outputpath);

        }

});

 }
 else
 { document.getElementById("om").innerHTML+='<br/><font color=red>combined_report'+d+m+yy+'.zip is not present on server</font>';
   n++;
   /*if(count.length==1){
        $("#p3").hide();
    }
   else
    {*/if(count.length>n)
        {
        setTimeout(function (){download_nse_cmbnd_rpt_zip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
        //document.getElementById("om").innerHTML+='<br/>Loading next....'+n;
        }
        else
        {
        //document.getElementById("om").innerHTML+="<br/>NSE cmbnd rpt is processing.."+n;
        //downloadmto(count,0,baseurl,downloadpath,unzippath,outputpath,logpath);
        //process_nse(count,0,baseurl,downloadpath,unzippath,outputpath);

    }
    }

}



/**************end of download bhav csv*************/



}
catch(err){
document.getElementById("om").innerHTML+="<br/>File is not found for this date: <br/>"+err;
setTimeout(function (){download_nse_cmbnd_rpt_zip(count,n,baseurl,downloadpath,unzippath,outputpath,logpath)}, 1000);
}
}